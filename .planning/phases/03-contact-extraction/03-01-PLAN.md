---
phase: 03-contact-extraction
plan: 01
type: execute
---

<objective>
Create the contact extraction function that parses natural language input into structured ContactData.

Purpose: This is the core AI feature - accurate extraction enables search and organization.
Output: extractContact onCall function with system prompt that handles both voice-to-text and typed shorthand input styles.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summaries:**
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/02-intent-classification/02-01-SUMMARY.md

**Key source files:**
@functions/src/services/claude.ts
@functions/src/types/contact.ts
@functions/src/prompts/intentClassification.ts
@functions/src/index.ts

**Tech stack available:**
- ClaudeService with complete() method
- ContactData interface with 10 optional fields
- onCall pattern with authentication and JSON parsing

**Established patterns:**
- System prompts in prompts/ directory
- JSON-only prompt responses for structured data
- Nested try-catch for JSON parse error handling
- 256 maxTokens for short responses (but extraction needs more)

**Constraining decisions:**
- 01-02: All ContactData fields optional - AI extraction may not find everything
- 01-02: rawNote always preserved - never lose original input
- 02-01: System prompts in prompts/ directory
- 02-01: JSON-only responses from Claude for structured output
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contact extraction system prompt</name>
  <files>functions/src/prompts/contactExtraction.ts</files>
  <action>
Create CONTACT_EXTRACTION_PROMPT that:

1. Instructs Claude to extract structured data from natural language contact notes
2. Maps to ContactData fields: name, company, title, meetingContext, location, tags, connections, phone, email, notes
3. Handles BOTH input styles:
   - Voice-to-text: "met john at the park he works at fifth third knows craig"
   - Typed shorthand: "john - park - fifth third - craig's friend"
4. Normalizes data:
   - Tags lowercase
   - Names capitalized properly
   - Company names standardized where obvious
5. Is conservative on ambiguous inference - only extract what's clearly stated
6. Returns ONLY valid JSON matching ContactData interface (no markdown, no explanation)

Include clear examples in the prompt showing both input styles and expected output.

Response format instruction:
Return ONLY valid JSON with no additional text. Include only fields that have values (omit null/empty fields).
  </action>
  <verify>File exists, exports CONTACT_EXTRACTION_PROMPT constant, TypeScript compiles</verify>
  <done>System prompt handles voice and typed input, returns clean JSON matching ContactData</done>
</task>

<task type="auto">
  <name>Task 2: Create extractContact onCall function</name>
  <files>functions/src/index.ts</files>
  <action>
Add extractContact onCall function following classifyIntent pattern:

1. Import CONTACT_EXTRACTION_PROMPT from prompts/contactExtraction
2. Add ExtractContactInput and ExtractContactResponse types to types/contact.ts if needed
3. Create onCall function with:
   - secrets: [anthropicApiKey]
   - timeoutSeconds: 60
   - memory: "256MiB"
4. Require authentication (throw HttpsError if !request.auth)
5. Validate input.rawNote exists and is string
6. Call claude.complete() with extraction prompt and rawNote
7. Use 512 maxTokens (extraction responses are longer than classification)
8. Parse JSON response with nested try-catch for parse errors
9. Return { extracted: ContactData, usage: { inputTokens, outputTokens } }

Follow the exact error handling pattern from classifyIntent:
- Re-throw HttpsErrors
- Log and wrap other errors as HttpsError("internal", ...)
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>extractContact function exported, accepts rawNote, returns ContactData structure</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd functions && npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] CONTACT_EXTRACTION_PROMPT exported from prompts/contactExtraction.ts
- [ ] extractContact function exported from index.ts
- [ ] Types are correct (ContactData returned in response)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- extractContact function follows established onCall pattern
- System prompt handles both voice-to-text and typed shorthand examples
</success_criteria>

<output>
After completion, create `.planning/phases/03-contact-extraction/03-01-SUMMARY.md` following summary.md template.

Update `.planning/STATE.md`:
- Current position: Phase 3, Plan 01 complete
- Add any new decisions to Accumulated Context
</output>
