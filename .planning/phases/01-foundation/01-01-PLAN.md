---
phase: 01-foundation
plan: 01
type: execute
---

<objective>
Set up Claude API integration with Firebase Functions using the Anthropic TypeScript SDK.

Purpose: Establish the core AI service that all contact operations depend on.
Output: Working ClaudeService class with secret management and a test function to verify integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md
@functions/src/index.ts
@functions/package.json

**Tech stack:** Firebase Functions v2 7.0.0, TypeScript 5.7.3, Node 24
**Model:** Claude Haiku 4.5 (`claude-haiku-4-5-20251001`)
**SDK:** @anthropic-ai/sdk v0.71.x

**From RESEARCH.md - Don't hand-roll:**
- Retry logic (SDK handles it)
- Rate limit handling (SDK handles it)
- Secret management (use Firebase defineSecret)
- Error classification (use SDK error types)

**From RESEARCH.md - Key patterns:**
- Service class receives API key at invocation
- Secret bound with `{ secrets: [key] }` option
- SDK timeout set to 60s for Firebase Functions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Anthropic SDK and configure Firebase secret</name>
  <files>functions/package.json</files>
  <action>
1. Install the Anthropic SDK:
   ```bash
   cd functions && npm install @anthropic-ai/sdk
   ```

2. Set up the Firebase secret (will prompt for value):
   ```bash
   firebase functions:secrets:set ANTHROPIC_API_KEY
   ```

3. For local development, create `.secret.local` in functions directory:
   ```
   ANTHROPIC_API_KEY=sk-ant-...
   ```
   (Add .secret.local to .gitignore if not already there)

Do NOT hardcode API keys. Do NOT use .env for secrets (not secure).
  </action>
  <verify>
- `npm ls @anthropic-ai/sdk` shows package installed
- `firebase functions:secrets:access ANTHROPIC_API_KEY` returns the key (if set)
  </verify>
  <done>@anthropic-ai/sdk in package.json dependencies, secret configured in Firebase</done>
</task>

<task type="auto">
  <name>Task 2: Create ClaudeService class</name>
  <files>functions/src/services/claude.ts</files>
  <action>
Create a reusable Claude service class following patterns from RESEARCH.md:

```typescript
// functions/src/services/claude.ts
import Anthropic from '@anthropic-ai/sdk';

export interface ClaudeResponse {
  text: string;
  inputTokens: number;
  outputTokens: number;
}

export class ClaudeService {
  private client: Anthropic;
  private model = 'claude-haiku-4-5-20251001';

  constructor(apiKey: string) {
    this.client = new Anthropic({
      apiKey,
      maxRetries: 2,      // SDK default, handles transient errors
      timeout: 60_000,    // 60s for Firebase Functions timeout
    });
  }

  async complete(
    systemPrompt: string,
    userMessage: string,
    maxTokens = 1024
  ): Promise<ClaudeResponse> {
    const message = await this.client.messages.create({
      model: this.model,
      max_tokens: maxTokens,
      system: systemPrompt,
      messages: [{ role: 'user', content: userMessage }],
    });

    const textBlock = message.content.find(block => block.type === 'text');

    return {
      text: textBlock?.text ?? '',
      inputTokens: message.usage.input_tokens,
      outputTokens: message.usage.output_tokens,
    };
  }
}
```

Key points:
- API key passed at construction (from defineSecret.value())
- Model hardcoded to Haiku 4.5 as per PROJECT.md constraint
- Timeout set to 60s (Firebase Functions default)
- Returns token counts for cost monitoring
- Do NOT add streaming yet (not needed for MVP)
  </action>
  <verify>`npm run build` succeeds with no TypeScript errors</verify>
  <done>ClaudeService class exists at functions/src/services/claude.ts, builds without errors</done>
</task>

<task type="auto">
  <name>Task 3: Create test function to verify Claude API integration</name>
  <files>functions/src/index.ts</files>
  <action>
Add a simple test function to verify the Claude API integration works:

1. Import required modules at top of index.ts:
```typescript
import {onCall, HttpsError} from "firebase-functions/v2/https";
import {defineSecret} from "firebase-functions/params";
import {ClaudeService} from "./services/claude";
```

2. Define the secret:
```typescript
const anthropicApiKey = defineSecret('ANTHROPIC_API_KEY');
```

3. Create a test function (temporary, for verification):
```typescript
export const testClaude = onCall(
  {
    secrets: [anthropicApiKey],
    timeoutSeconds: 60,
    memory: '256MiB',
  },
  async (request) => {
    // Require authentication
    if (!request.auth) {
      throw new HttpsError('unauthenticated', 'Must be authenticated');
    }

    const claude = new ClaudeService(anthropicApiKey.value());

    try {
      const response = await claude.complete(
        'You are a helpful assistant. Respond briefly.',
        'Say hello and confirm you are Claude Haiku 4.5.'
      );

      return {
        success: true,
        response: response.text,
        usage: {
          inputTokens: response.inputTokens,
          outputTokens: response.outputTokens,
        },
      };
    } catch (error) {
      // Log for debugging
      console.error('Claude API error:', error);
      throw new HttpsError('internal', 'Claude API call failed');
    }
  }
);
```

Key points:
- Uses onCall (not onRequest) per PROJECT.md decision
- Secrets bound with `{ secrets: [anthropicApiKey] }`
- Requires authentication (request.auth check)
- Returns usage stats for cost monitoring
- Basic error handling (detailed error types in Phase 5)
  </action>
  <verify>
1. `npm run build` succeeds
2. `npm run serve` starts emulator without errors
3. (Optional) Call testClaude from Firebase console or curl to verify end-to-end
  </verify>
  <done>testClaude function exported, builds successfully, emulator starts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd functions && npm run build` succeeds without errors
- [ ] `npm ls @anthropic-ai/sdk` shows package installed
- [ ] `npm run lint` passes (or only pre-existing warnings)
- [ ] functions/src/services/claude.ts exists with ClaudeService class
- [ ] functions/src/index.ts exports testClaude function
- [ ] Emulator starts without errors (`npm run serve`)
</verification>

<success_criteria>
- @anthropic-ai/sdk installed as dependency
- Firebase secret ANTHROPIC_API_KEY configured
- ClaudeService class created with complete() method
- testClaude onCall function exported for verification
- All TypeScript compiles without errors
- Emulator starts successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md` using summary template.

Include:
- SDK version installed
- Files created/modified
- Any issues encountered with secret setup
- Ready for Plan 01-02 (Contact data model)
</output>
