---
phase: 02-intent-classification
plan: 01
type: execute
---

<objective>
Create intent classification function that routes user input to add/update/search operations.

Purpose: First step in the AI pipeline - understand what the user wants before processing
Output: classifyIntent onCall function with system prompt and type definitions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summaries:**
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

**Key source files:**
@functions/src/services/claude.ts
@functions/src/types/contact.ts
@functions/src/index.ts

**Tech stack available:**
- @anthropic-ai/sdk@0.71.2
- ClaudeService class with complete() method
- Firebase onCall v2 pattern (see testClaude in index.ts)

**Established patterns:**
- Service class with injected secret (ClaudeService)
- onCall function with secrets array, timeoutSeconds, memory options
- Double quotes, 2-space indent (Google style)
- JSDoc comments required

**Constraining decisions:**
- 01-01: Hardcoded Haiku 4.5 model - already in ClaudeService
- 01-01: 60s timeout for Firebase Functions compatibility
- 01-02: Separate input types for create/update/search operations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create intent types and system prompt</name>
  <files>functions/src/types/intent.ts, functions/src/types/index.ts, functions/src/prompts/intentClassification.ts</files>
  <action>
Create intent type definitions:
- Intent type: "add" | "update" | "search"
- ClassifyIntentInput: { text: string }
- ClassifyIntentResponse: { intent: Intent, confidence: "high" | "low", reasoning?: string }

Create system prompt for intent classification:
- Classify user input as one of three intents
- "add": User is describing someone they met (new contact)
- "update": User wants to modify existing contact (mentions "update", "change", refers to existing person by context)
- "search": User is looking for someone (asking "who", "find", "which person")
- Return JSON only: { "intent": "add"|"update"|"search", "confidence": "high"|"low" }
- Include reasoning only when confidence is low
- Handle ambiguous cases: default to "add" for new info, "search" for questions

Update types/index.ts barrel to export intent types.

Follow project conventions: double quotes, 2-space indent, JSDoc comments.
  </action>
  <verify>npm run build passes with new type files</verify>
  <done>Intent types exported, prompt file created with system prompt string</done>
</task>

<task type="auto">
  <name>Task 2: Create classifyIntent function</name>
  <files>functions/src/index.ts</files>
  <action>
Add classifyIntent onCall function to index.ts:
- Same pattern as testClaude: onCall with secrets, timeoutSeconds: 60, memory: "256MiB"
- Require authentication (throw HttpsError if !request.auth)
- Extract text from request.data (validate it exists, throw HttpsError "invalid-argument" if missing)
- Create ClaudeService with anthropicApiKey.value()
- Call claude.complete() with intent system prompt and user text
- Parse JSON response (handle parse errors gracefully)
- Return ClassifyIntentResponse to frontend
- Use maxTokens: 256 (intent classification is short)

Error handling:
- Invalid input: throw HttpsError("invalid-argument", "Text is required")
- Claude API error: log and throw HttpsError("internal", "Classification failed")
- JSON parse error: log raw response and throw HttpsError("internal", "Invalid response format")

Import the system prompt from prompts/intentClassification.ts.
Import types from types/index.ts.
  </action>
  <verify>npm run build succeeds, npm run lint passes</verify>
  <done>classifyIntent function exported, handles all error cases, returns typed response</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] classifyIntent function exported from index.ts
- [ ] Intent types exported from types/index.ts
- [ ] System prompt handles add/update/search classification
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- classifyIntent function follows same pattern as testClaude
- System prompt is clear and handles edge cases
- Types are properly exported for frontend consumption
- Phase 2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-intent-classification/02-01-SUMMARY.md` using summary.md template.

Update `.planning/STATE.md`:
- Current Position: Phase 3
- Add to Accumulated Decisions if any new decisions made
</output>
