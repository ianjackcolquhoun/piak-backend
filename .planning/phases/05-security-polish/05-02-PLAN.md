---
phase: 05-security-polish
plan: 02
type: execute
---

<objective>
Refine system prompts to improve extraction accuracy for edge cases.

Purpose: Improve AI extraction quality by handling edge cases discovered through usage patterns.
Output: Enhanced contactExtraction prompt with better edge case handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Current extraction prompt:**
@functions/src/prompts/contactExtraction.ts

**Key insight from PROJECT.md:**
- "System Prompts: Most critical piece. Expect 10-20 iterations to get extraction accuracy right."
- Handle both voice and typed input styles
- Normalize data (lowercase tags, standardize company names)
- Be conservative on ambiguous inference
- Return clean JSON without markdown/explanation

**Established patterns:**
- 512 maxTokens for extraction responses
- JSON-only output format
- Multi-line JSON examples in prompts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance extraction prompt with edge case handling</name>
  <files>functions/src/prompts/contactExtraction.ts</files>
  <action>
Improve the CONTACT_EXTRACTION_PROMPT to handle common edge cases:

1. **Multiple people mentioned**: When input mentions multiple people, extract only the PRIMARY contact (the person being added). Example: "met john who introduced me to sarah and mike" → extract John only, put sarah/mike in connections.

2. **Ambiguous company vs location**: When a place name could be company or location, prefer context clues. "met at google" = meetingContext, "works at google" = company.

3. **Partial names**: Handle single names gracefully - don't require last name. "John" is valid, don't infer "John Doe".

4. **Time references**: Extract meetingContext from temporal phrases. "met yesterday at coffee shop" → meetingContext: "coffee shop, yesterday" or just "coffee shop".

5. **Pronouns and context**: Handle "her", "his" etc. when name precedes. "Sarah, her number is 555-1234" → name: Sarah, phone: 555-1234.

Add these as explicit rules in the prompt with examples. Keep existing rules, add clarifications.

Do NOT change the response format - keep JSON-only output.
  </action>
  <verify>npm run build succeeds (TypeScript compiles)</verify>
  <done>Extraction prompt enhanced with edge case rules and examples</done>
</task>

<task type="auto">
  <name>Task 2: Test extraction with edge cases</name>
  <files>N/A (verification only)</files>
  <action>
Deploy and test the updated prompt with edge case inputs:

1. Deploy: cd functions && npm run deploy
2. Use testClaude or extractContact to verify these inputs produce expected output:
   - "met john who introduced me to sarah" → John with sarah in connections
   - "Sarah from the google office" → interpret based on phrasing
   - "Mike, met him at the conference last week" → meetingContext includes conference

If testing in emulator, run: npm run serve then test locally.

Document any issues found for future iteration (add to SUMMARY.md).
  </action>
  <verify>Functions deploy successfully, extraction produces reasonable output for edge cases</verify>
  <done>Updated prompt tested, edge cases handled or documented for future iteration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] Prompt contains new edge case rules
- [ ] Functions deploy without errors
- [ ] Basic edge case testing completed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Extraction prompt improved with edge case handling
- Phase 5 complete - milestone finished
</success_criteria>

<output>
After completion, create `.planning/phases/05-security-polish/05-02-SUMMARY.md`

Note: This is the final plan in Phase 5. Mark "Phase 5 complete" in summary.
</output>
